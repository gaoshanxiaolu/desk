#!/bin/sh
# Copyright (c) 2008 Atheros Communications Inc.
# All rights reserved.
# $ATH_LICENSE_TARGET_MK$

# arg1: output linker script filename

# This script generates a finalized linker script based on its template file:
# - if ${1}.template does not exist it will use the default template file
#   ${2}/athos.target_iot.ld.template
# Example usage:
#     build_ld.sh apps/sdk_shell/sdk_shell.7.6.ld romexport/AR6002/hw7.6

Usage() {
    echo Usage:
    echo $progname '<linker script name>'
    exit 1
}

progname=$0

if [ -z "$1" ]
then
    Usage
fi

if [ $1 == "apps/otp/otp.7.6.ld" ]
then
    echo "otp use its own ld script"
    exit 
fi

# use the default IOT linker script body file if a custom one is not found
if [ ! -r "$1.template" ]
then
    A_TEMPLATEFILE="${2}/athos.target_iot.ld.template"
else
    A_TEMPLATEFILE="${1}.template"
fi

# check to make sure all these env variables are set
: ${A_LITSEG_BASE:?"$progname: Need to set A_LITSEG_BASE non-empty"}
: ${A_LITSEG_SIZE:?"$progname: Need to set A_LITSEG_SIZE non-empty"}
: ${A_IOT_LITSEG_SIZE:?"$progname: Need to set A_IOT_LITSEG_SIZE non-empty"}
: ${A_PROXY_IRAM_SIZE:?"$progname: Need to set A_PROXY_IRAM_SIZE non-empty"}
: ${A_IRAM_MAX:?"$progname: Need to set A_IRAM_MAX non-empty"}
: ${A_DRAM_BASE:?"$progname: Need to set A_DRAM_BASE non-empty"}
: ${A_PROXY_DRAM_SIZE:?"$progname: Need to set A_PROXY_DRAM_SIZE non-empty"}
: ${A_DRAM_MAX:?"$progname: Need to set A_DRAM_MAX non-empty"}

# examine the template file MEMORY { } section to see if it references a proxy
PROXY_PRESENT=`awk '{ if ($1 == "}") exit; else  { print; }}' ${A_TEMPLATEFILE}  | grep -c -i proxy`
# echo "PROXY_PRESENT = $PROXY_PRESENT"

# IOT builds (proxies and apps that load with a proxy) need more space for literals
if [ $PROXY_PRESENT -ge 1 ]; then
    A_LITSEG_SIZE=$A_IOT_LITSEG_SIZE
fi

# some calculated values. not all may be used for a particular linker script
if [ -n "$A_MOD_LITSEG_SIZE" ]; then
    A_IRAM_BASE_dec=$(($A_LITSEG_BASE + $A_LITSEG_SIZE + $A_MOD_LITSEG_SIZE))
else
    A_IRAM_BASE_dec=$(($A_LITSEG_BASE + $A_LITSEG_SIZE))
fi
A_IRAM_BASE=0x$($PRINTF "%08X" $A_IRAM_BASE_dec)
A_APP_IRAM_BASE_dec=$(($A_IRAM_BASE + $A_PROXY_IRAM_SIZE))
A_APP_IRAM_BASE=0x$($PRINTF "%08X" $A_APP_IRAM_BASE_dec)
A_APP_IRAM_SIZE_dec=$(($A_IRAM_MAX - $A_APP_IRAM_BASE))
A_APP_IRAM_SIZE=0x$($PRINTF "%08X" $A_APP_IRAM_SIZE_dec)
A_APP_DRAM_BASE_dec=$(($A_DRAM_BASE + $A_PROXY_DRAM_SIZE))
A_APP_DRAM_BASE=0x$($PRINTF "%08X" $A_APP_DRAM_BASE_dec)
A_APP_DRAM_SIZE_dec=$(($A_DRAM_MAX - $A_APP_DRAM_BASE))
A_APP_DRAM_SIZE=0x$($PRINTF "%08X" $A_APP_DRAM_SIZE_dec)

# remove any previously-generated linker script file
rm -f "$1"

echo '/* DO NOT EDIT THIS FILE! IT IS AUTO-GENERATED BY THE BUILD PROCESS. */' > "$1"

# do the substitutions on the template file to produce a valid linker script
sed -e "
s/\%LITSEG_BASE\%/$A_LITSEG_BASE/g 
s/\%LITSEG_SIZE\%/$A_LITSEG_SIZE/g 
s/\%IRAM_BASE\%/$A_IRAM_BASE/g 
s/\%PROXY_IRAM_SIZE\%/$A_PROXY_IRAM_SIZE/g 
s/\%APP_IRAM_BASE\%/$A_APP_IRAM_BASE/g 
s/\%APP_IRAM_SIZE\%/$A_APP_IRAM_SIZE/g 
s/\%DRAM_BASE\%/$A_DRAM_BASE/g 
s/\%PROXY_DRAM_SIZE\%/$A_PROXY_DRAM_SIZE/g 
s/\%APP_DRAM_BASE\%/$A_APP_DRAM_BASE/g 
s/\%APP_DRAM_SIZE\%/$A_APP_DRAM_SIZE/g 
" < "$A_TEMPLATEFILE" >> "$1"

echo "$progname: produced linker script $1"
